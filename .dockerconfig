# vim: set ft=sh:
export COMPOSE_HTTP_TIMEOUT=999999

# Alias
alias d="docker"

# Youtily service portal
alias syp='echo "==> Starting docker-machine..." &&
  cd ~/dev/youtily/service-portal &&
  docker-machine restart youtily-portal &&
  docker-machine env youtily-portal &&
  eval "$(docker-machine env youtily-portal)" &&
  echo "==> Starting docker containers..." &&
  docker-compose up -d'

# Docker shortcuts
dc() {
  if [[ $# -eq 1 ]]; then
    case $1 in
     'bash')
        docker-compose exec app bash;;
      'logs')
        docker-compose logs -f app;;
      'test')
        docker-compose exec app python manage.py test -n;;
      'up')
          docker-compose up -d $args;;
      *)
        docker-compose "$@";;
    esac
  else
    case $1 in
      'logs')
        docker-compose logs -f "${@:2}";;
      'bash')
        docker-compose exec "${@:2}" bash;;
      *)
        docker-compose "$@";;
    esac
  fi
}

dm() {
  if [[ $# -eq 1 ]]; then
    case $1 in
      *)
        docker-machine "$@";;
    esac
  else
    docker-machine "$@"
  fi
}

dme() {
  if [[ $# -eq 0 ]]; then
    echo 'Usage: dme <docker-machine name>'
    return 1
  fi

  MACHINE=$1
  AVAILABLE_MACHINES=($(docker-machine ls -q))

  if [[ $(echo ${AVAILABLE_MACHINES[@]} | grep -x ${MACHINE} | wc -w) ]]; then
    eval $(docker-machine env $MACHINE)
    echo "==> ${MACHINE} configured for this session"
  else
    echo "${MACHINE} isn't available. Available docker-machine's:"
    printf '%s\n' "${AVAILABLE_MACHINES[@]}"
  fi
}

de() {
  if [[ $# -eq 0 || ${1} =~ 'help' ]]; then
    echo 'Docker helper to connect to a running container'
    echo 'Usage: de <container> [<command>]'
    return 1
  fi

  REQ_ARG=$1
  DEF_ARG=${2:-bash}
  OPT_ARG=${@:3}

  docker exec -ti $REQ_ARG $DEF_ARG $OPT_ARG
}
